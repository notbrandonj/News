import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, query, where, getDocs, addDoc, onSnapshot } from 'firebase/firestore'; // Removed orderBy as it's not used in queries directly

// Firebase configuration (provided by the Canvas environment)
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

// Main App Component
const App = () => {
    const [newsStories, setNewsStories] = useState([]);
    const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]); // YYYY-MM-DD
    const [availableDates, setAvailableDates] = useState([]);
    const [loading, setLoading] = useState(true);
    const [userId, setUserId] = useState(null);
    const isAuthReady = useRef(false);

    // Effect for Firebase Authentication and Firestore Initialization
    useEffect(() => {
        let unsubscribeAuth;

        const initAuthAndListen = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                // After successful sign-in, set up the listener
                unsubscribeAuth = onAuthStateChanged(auth, (user) => {
                    if (user) {
                        setUserId(user.uid);
                        console.log("User authenticated:", user.uid);
                    } else {
                        // This case should ideally not happen if signInAnonymously/signInWithCustomToken succeeded
                        // but good to handle for robustness.
                        setUserId(crypto.randomUUID()); // Fallback to random ID if no authenticated user
                        console.log("Signed out or anonymous user.");
                    }
                    isAuthReady.current = true; // Auth is now ready and user ID is set
                });
            } catch (error) {
                console.error("Firebase initial authentication error:", error);
                // Even if auth fails, we might still want to proceed with a random userId for non-auth features
                setUserId(crypto.randomUUID());
                isAuthReady.current = true; // Mark as ready even if auth failed, so data fetching can proceed (and likely fail with permissions)
            }
        };

        initAuthAndListen();

        return () => {
            if (unsubscribeAuth) {
                unsubscribeAuth(); // Cleanup auth listener
            }
        };
    }, []); // Empty dependency array means this runs once on mount

    // Effect for fetching available dates and news stories
    useEffect(() => {
        if (!isAuthReady.current || !userId) {
            console.log("Auth not ready or userId not set, skipping data fetch. isAuthReady:", isAuthReady.current, "userId:", userId);
            return; // Wait for authentication to be ready
        }

        const fetchAvailableDates = async () => {
            try {
                // Fetch all news stories to get unique dates
                const newsCollectionRef = collection(db, `artifacts/${appId}/public/data/newsStories`);
                const q = query(newsCollectionRef); // No orderBy here to avoid index issues
                const querySnapshot = await getDocs(q);
                const dates = new Set();
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.date) {
                        dates.add(data.date);
                    }
                });
                // Sort dates in descending order (most recent first)
                const sortedDates = Array.from(dates).sort((a, b) => new Date(b) - new Date(a));
                setAvailableDates(sortedDates);

                // If no date is selected yet, or the current selected date is not available,
                // set the selected date to the most recent available date.
                if (!selectedDate || !sortedDates.includes(selectedDate)) {
                    if (sortedDates.length > 0) {
                        setSelectedDate(sortedDates[0]);
                    } else {
                        // If no news, default to today's date
                        setSelectedDate(new Date().toISOString().split('T')[0]);
                    }
                }
            } catch (error) {
                console.error("Error fetching available dates:", error);
            }
        };

        // Fetch news stories for the currently selected date
        const fetchNewsStories = () => {
            if (!selectedDate) {
                setNewsStories([]);
                setLoading(false);
                return;
            }

            setLoading(true);
            const newsCollectionRef = collection(db, `artifacts/${appId}/public/data/newsStories`);
            // Query for stories on the selected date, ordered by a timestamp if available
            const q = query(newsCollectionRef, where("date", "==", selectedDate));

            const unsubscribe = onSnapshot(q, (snapshot) => {
                const stories = [];
                snapshot.forEach((doc) => {
                    stories.push({ id: doc.id, ...doc.data() });
                });
                // Sort stories by timestamp if available, otherwise by headline
                stories.sort((a, b) => {
                    if (a.timestamp && b.timestamp) {
                        // Ensure timestamp is a Date object if it's a Firestore Timestamp
                        const tsA = a.timestamp.toDate ? a.timestamp.toDate() : a.timestamp;
                        const tsB = b.timestamp.toDate ? b.timestamp.toDate() : b.timestamp;
                        return tsB - tsA;
                    }
                    return a.headline.localeCompare(b.headline);
                });
                setNewsStories(stories);
                setLoading(false);
            }, (error) => {
                console.error("Error fetching news stories:", error);
                setLoading(false);
            });

            return () => unsubscribe(); // Cleanup snapshot listener
        };

        fetchAvailableDates();
        fetchNewsStories();

    }, [db, userId, selectedDate, isAuthReady.current]); // Re-run when db, userId, or selectedDate changes

    // Function to add dummy news data (for initial setup/testing)
    const addDummyNews = async () => {
        // Example data for different dates
        const dummyData = [
            {
                date: new Date().toISOString().split('T')[0], // Today
                headline: "Breaking News: Local Community Initiative Launched Today",
                linkedTextUrl: "https://example.com/linked-text-today",
                linkedTextLabel: "(More Info)",
                socialLinkUrl: "https://twitter.com/intent/tweet?text=Check%20out%20this%20news!%20%23CommunityNews",
                socialLinkType: "twitter",
                content: "A new community initiative aimed at improving local parks and recreational facilities was officially launched today. The project, spearheaded by the 'Green Spaces Alliance,' plans to involve volunteers from all age groups to contribute to the beautification and maintenance of public areas. 'We believe that vibrant public spaces are essential for the well-being of our community,' said Sarah Chen, spokesperson for the alliance. 'This initiative is a testament to what we can achieve when we work together.'",
                timestamp: new Date(),
            },
            {
                date: new Date(Date.now() - 86400000).toISOString().split('T')[0], // Yesterday
                headline: "Yesterday's Tech Innovations: New AI Assistant Unveiled",
                linkedTextUrl: "https://example.com/tech-review-yesterday",
                linkedTextLabel: "(Read Review)",
                socialLinkUrl: "https://www.facebook.com/sharer/sharer.php?u=https://example.com/ai-assistant",
                socialLinkType: "facebook",
                content: "A leading technology firm yesterday unveiled its latest artificial intelligence assistant, designed to streamline daily tasks and enhance productivity for users across various industries. The new AI, named 'Synapse,' boasts advanced natural language processing capabilities and machine learning algorithms. Early reviews suggest Synapse could revolutionize how individuals interact with their digital environments, offering personalized assistance and predictive insights.",
                timestamp: new Date(Date.now() - 86400000),
            },
            {
                date: new Date(Date.now() - 2 * 86400000).toISOString().split('T')[0], // Two days ago
                headline: "Environmental Update: Global Efforts to Combat Climate Change (Archived)",
                linkedTextUrl: "https://example.com/climate-report-2daysago",
                linkedTextLabel: "(Full Report)",
                socialLinkUrl: "https://www.linkedin.com/shareArticle?mini=true&url=https://example.com/climate-report&title=Global%20Climate%20Efforts",
                socialLinkType: "linkedin",
                content: "International leaders and environmental organizations are intensifying their efforts to address global climate change, with new commitments announced at a recent summit. The focus is on transitioning to renewable energy sources and implementing sustainable practices worldwide. Scientists emphasize the urgency of these actions, highlighting recent data on rising temperatures and extreme weather events.",
                timestamp: new Date(Date.now() - 2 * 86400000),
            },
            {
                date: new Date().toISOString().split('T')[0], // Another story for today
                headline: "Local Sports: City Team Wins Championship",
                linkedTextUrl: "https://example.com/sports-today",
                linkedTextLabel: "(Highlights)",
                socialLinkUrl: "https://twitter.com/intent/tweet?text=City%20Team%20Wins!%20%23LocalSports",
                socialLinkType: "twitter",
                content: "The local city team clinched the championship title in a thrilling match last night, marking a historic victory for the community. Fans celebrated late into the evening, praising the team's dedication and skill throughout the season.",
                timestamp: new Date(),
            },
        ];

        try {
            const newsCollectionRef = collection(db, `artifacts/${appId}/public/data/newsStories`);
            for (const story of dummyData) {
                await addDoc(newsCollectionRef, story);
            }
            // Using a custom modal/message box instead of alert()
            // For simplicity, let's just log a success message for now.
            console.log("Dummy news added successfully!");
        } catch (e) {
            console.error("Error adding document: ", e);
            // Using a custom modal/message box instead of alert()
            console.error("Error adding dummy news: " + e.message);
        }
    };

    const handleDateChange = (event) => {
        setSelectedDate(event.target.value);
    };

    // Collapsible News Story Component
    const NewsStory = ({ story }) => {
        const [isExpanded, setIsExpanded] = useState(false);

        const toggleExpand = () => {
            setIsExpanded(!isExpanded);
        };

        const getSocialIcon = (type) => {
            switch (type) {
                case 'twitter':
                    return (
                        <svg className="w-5 h-5 inline-block" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path d="M8.29 20.251c7.547 0 11.675-6.253 11.675-11.675 0-.178 0-.355-.012-.53A8.348 8.348 0 0022 5.92a8.19 8.19 0 01-2.357.646 4.118 4.118 0 001.804-2.27 8.224 8.224 0 01-2.605.996 4.107 4.107 0 00-6.993 3.743 11.65 11.65 0 01-8.457-4.287 4.106 4.106 0 001.27 5.477A4.073 4.073 0 01.8 10.702V10.7c0 4.475 3.19 8.19 7.46 9.044a4.107 4.107 0 01-1.845.07 4.11 4.11 0 003.834 2.85A8.233 8.233 0 010 16.491a11.616 11.616 0 0017.863-11.722c.11-.29.22-.58.33-.87a8.354 8.354 0 002.04-2.177z"></path>
                        </svg>
                    );
                case 'facebook':
                    return (
                        <svg className="w-5 h-5 inline-block" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path d="M22 12c0-5.523-4.477-10-10-10S2 6.477 2 12c0 4.991 3.657 9.128 8.438 9.878v-6.987h-2.54V12h2.54V9.797c0-2.505 1.492-3.89 3.776-3.89 1.094 0 2.24.195 2.24.195v2.46h-1.26c-1.247 0-1.646.773-1.646 1.572V12h2.773l-.443 2.89h-2.33V22H12c5.523 0 10-4.477 10-10z"></path>
                        </svg>
                    );
                case 'linkedin':
                    return (
                        <svg className="w-5 h-5 inline-block" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                            <path d="M20.447 20.452h-3.554v-5.569c0-1.325-.028-3.044-1.853-3.044-1.854 0-2.136 1.445-2.136 2.951v5.662H9.59V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.07 0-1.145.92-2.07 2.063-2.07 1.144 0 2.064.925 2.064 2.07 0 1.144-.921 2.07-2.064 2.07zm1.789 13.019H3.548V9h3.588v11.452zM22.227 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.456c.98 0 1.772-.773 1.772-1.729V1.729C24 .774 23.207 0 22.227 0z"></path>
                        </svg>
                    );
                default:
                    return null;
            }
        };

        return (
            <div className="mb-6 border border-gray-600 rounded-lg overflow-hidden">
                <div
                    className={`collapsible-header bg-blue-700 text-white p-4 rounded-t-lg hover:bg-blue-800 transition-colors duration-200 ${isExpanded ? 'expanded' : ''}`}
                    onClick={toggleExpand}
                >
                    <h2 className="text-xl font-semibold flex-grow">
                        {story.headline}
                        {story.linkedTextUrl && story.linkedTextLabel && (
                            <a href={story.linkedTextUrl} className="social-link text-blue-300 hover:text-blue-200" target="_blank" rel="noopener noreferrer">
                                {story.linkedTextLabel}
                            </a>
                        )}
                    </h2>
                    <div className="flex items-center">
                        {story.socialLinkUrl && story.socialLinkType && (
                            <a href={story.socialLinkUrl} className="social-link text-blue-300 hover:text-blue-200" target="_blank" rel="noopener noreferrer">
                                {getSocialIcon(story.socialLinkType)}
                            </a>
                        )}
                        <span className="arrow-icon ml-3 text-2xl font-bold">{isExpanded ? '-' : '+'}</span>
                    </div>
                </div>
                <div className={`collapsible-content bg-gray-800 p-4 text-gray-300 ${isExpanded ? 'expanded' : ''}`}>
                    <p className="mb-4">{story.content}</p>
                </div>
            </div>
        );
    };

    if (!userId || loading) {
        return (
            <div className="flex items-center justify-center min-h-screen bg-gray-800 text-white">
                <p>Loading news stories...</p>
            </div>
        );
    }

    return (
        <div className="bg-gray-800 p-4 sm:p-8 min-h-screen">
            <div className="max-w-4xl mx-auto bg-gray-700 shadow-lg rounded-xl p-6 sm:p-8">
                <h1 className="text-4xl font-extrabold text-white mb-4 text-center">Latest News Headlines</h1>
                <p className="text-sm text-gray-400 text-center mb-6">User ID: {userId}</p>

                <div className="mb-6 flex flex-col sm:flex-row justify-between items-center gap-4">
                    <label htmlFor="date-select" className="text-white text-lg font-medium">View News For:</label>
                    <select
                        id="date-select"
                        value={selectedDate}
                        onChange={handleDateChange}
                        className="p-2 rounded-md bg-gray-600 text-white border border-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                        {availableDates.length > 0 ? (
                            availableDates.map(date => (
                                <option key={date} value={date}>{date}</option>
                            ))
                        ) : (
                            <option value="">No dates available</option>
                        )}
                    </select>
                    <button
                        onClick={addDummyNews}
                        className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-200 shadow-md"
                    >
                        Add Dummy News (for testing)
                    </button>
                </div>

                {newsStories.length > 0 ? (
                    newsStories.map(story => (
                        <NewsStory key={story.id} story={story} />
                    ))
                ) : (
                    <p className="text-center text-gray-400 text-lg">No news stories found for {selectedDate}.</p>
                )}
            </div>
        </div>
    );
};

export default App;
